name: Deploy ðŸ—ï¸

on:
  workflow_call:
    inputs:
      branch:
        required: true
        type: string
      environment:
        required: true
        type: string
      artifact_name:
        required: false
        type: string
        default: package

jobs:
  deploy:
    name: Deploy to ${{ inputs.environment }} ðŸ“ƒ
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.environment }}
      url: https://${{ inputs.environment }}.titanos.jellyfin.org

    steps:
      - name: Download workflow artifact â¬‡ï¸
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: ${{ inputs.artifact_name }}
          path: dist/package

      - name: Configure deployment ðŸ”
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_APPS_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "${{ secrets.DEPLOY_APPS_HOST }}" >> ~/.ssh/known_hosts

      - name: Deploy to ${{ inputs.environment }}.titanos.jellyfin.org ðŸš€
        env:
          TARGET_PATH: /srv/titanos/${{ inputs.environment }}/
          SOURCE_PATH: dist/package/
        run: rsync -vrptz -e "ssh -i ~/.ssh/id_rsa" "$SOURCE_PATH" "${{ secrets.DEPLOY_APPS_USER }}@${{ secrets.DEPLOY_APPS_HOST }}:$TARGET_PATH"
